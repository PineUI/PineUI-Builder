<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PineUI Builder</title>

  <!-- Material Symbols -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />
  <!-- PineUI CSS -->
  <link rel="stylesheet" href="https://pineui.github.io/PineUI/pineui.css" />

  <style>
    :root {
      --md-sys-color-primary: #6750A4;
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-primary-container: #EADDFF;
      --md-sys-color-on-primary-container: #21005D;
      --md-sys-color-secondary: #625B71;
      --md-sys-color-secondary-container: #E8DEF8;
      --md-sys-color-surface: #141218;
      --md-sys-color-surface-variant: #1E1B21;
      --md-sys-color-surface-container: #211F26;
      --md-sys-color-surface-container-high: #2B2930;
      --md-sys-color-on-surface: #E6E1E5;
      --md-sys-color-on-surface-variant: #CAC4D0;
      --md-sys-color-outline: #938F99;
      --md-sys-color-outline-variant: #49454F;
      --md-sys-color-error: #F2B8B5;
      --md-ref-typeface-brand: 'Inter', sans-serif;
      --md-ref-typeface-plain: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: var(--md-sys-color-surface-container);
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      flex-shrink: 0;
    }
    .topbar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .topbar-logo .pine-icon {
      width: 32px;
      height: 32px;
      background: var(--md-sys-color-primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .topbar-logo h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--md-sys-color-on-surface);
      letter-spacing: -0.3px;
    }
    .topbar-logo span {
      font-size: 11px;
      font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      background: var(--md-sys-color-surface-container-high);
      padding: 2px 8px;
      border-radius: 100px;
      border: 1px solid var(--md-sys-color-outline-variant);
    }
    .topbar-spacer { flex: 1; }
    .topbar-hint {
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Chat panel ‚îÄ‚îÄ */
    .chat-panel {
      width: 420px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--md-sys-color-outline-variant);
      background: var(--md-sys-color-surface);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scrollbar-width: thin;
      scrollbar-color: var(--md-sys-color-outline-variant) transparent;
    }

    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 32px;
      text-align: center;
    }
    .chat-empty .empty-icon {
      width: 56px;
      height: 56px;
      background: var(--md-sys-color-primary-container);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: var(--md-sys-color-on-primary-container);
    }
    .chat-empty h2 {
      font-size: 16px;
      font-weight: 600;
      color: var(--md-sys-color-on-surface);
    }
    .chat-empty p {
      font-size: 13px;
      color: var(--md-sys-color-on-surface-variant);
      line-height: 1.5;
    }

    .suggestion-chips {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      width: 100%;
    }
    .chip-btn {
      background: var(--md-sys-color-surface-container);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 12px;
      padding: 10px 14px;
      color: var(--md-sys-color-on-surface);
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      text-align: left;
      transition: background 0.15s, border-color 0.15s;
      line-height: 1.4;
    }
    .chip-btn:hover {
      background: var(--md-sys-color-surface-container-high);
      border-color: var(--md-sys-color-primary);
    }

    /* Messages */
    .message {
      display: flex;
      gap: 10px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.user { flex-direction: row-reverse; }

    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }
    .msg-avatar.ai {
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
    }
    .msg-avatar.user-av {
      background: var(--md-sys-color-secondary-container);
      color: #1D1B20;
    }

    .msg-bubble {
      max-width: 85%;
      border-radius: 16px;
      padding: 10px 14px;
      font-size: 13px;
      line-height: 1.6;
    }
    .message.user .msg-bubble {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      border-bottom-right-radius: 4px;
    }
    .message.ai .msg-bubble {
      background: var(--md-sys-color-surface-container);
      color: var(--md-sys-color-on-surface);
      border-bottom-left-radius: 4px;
    }
    .msg-bubble .msg-description {
      color: var(--md-sys-color-on-surface-variant);
      font-size: 12px;
      line-height: 1.5;
    }
    .msg-bubble .msg-view-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      font-size: 12px;
      font-weight: 500;
      color: #D0BCFF;
      cursor: pointer;
      background: none;
      border: none;
      padding: 4px 0;
      font-family: 'Inter', sans-serif;
    }
    .msg-bubble .msg-view-btn:hover { text-decoration: underline; }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 4px 0;
    }
    .typing-dot {
      width: 6px;
      height: 6px;
      background: var(--md-sys-color-on-surface-variant);
      border-radius: 50%;
      animation: typing 1.2s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-4px); opacity: 1; }
    }

    /* Chat input */
    .chat-input-area {
      padding: 12px 16px 16px;
      border-top: 1px solid var(--md-sys-color-outline-variant);
      background: var(--md-sys-color-surface);
    }
    .chat-input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: var(--md-sys-color-surface-container);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 16px;
      padding: 8px 8px 8px 16px;
      transition: border-color 0.2s;
    }
    .chat-input-wrapper:focus-within {
      border-color: var(--md-sys-color-primary);
    }
    #chat-input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--md-sys-color-on-surface);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    #chat-input::placeholder { color: var(--md-sys-color-on-surface-variant); }

    .send-btn {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: var(--md-sys-color-primary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--md-sys-color-on-primary);
      flex-shrink: 0;
      transition: background 0.15s, opacity 0.15s;
    }
    .send-btn:hover:not(:disabled) { background: #7966AF; }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .send-btn .material-symbols-rounded { font-size: 18px; }

    /* ‚îÄ‚îÄ Preview panel ‚îÄ‚îÄ */
    .preview-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--md-sys-color-surface-variant);
      overflow: hidden;
    }

    .preview-toolbar {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--md-sys-color-surface-container);
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      gap: 12px;
      flex-shrink: 0;
    }

    .preview-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      flex: 1;
    }

    /* Segmented button toggle */
    .toggle-group {
      display: flex;
      border: 1px solid var(--md-sys-color-outline);
      border-radius: 100px;
      overflow: hidden;
    }
    .toggle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 16px;
      font-size: 12px;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      border: none;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      background: transparent;
      color: var(--md-sys-color-on-surface-variant);
    }
    .toggle-btn.active {
      background: var(--md-sys-color-secondary-container);
      color: #1D1B20;
    }
    .toggle-btn:not(.active):hover {
      background: rgba(255,255,255,0.05);
    }
    .toggle-btn .material-symbols-rounded { font-size: 14px; }

    .copy-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 100px;
      cursor: pointer;
      background: transparent;
      color: var(--md-sys-color-on-surface-variant);
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .copy-btn:hover {
      background: var(--md-sys-color-surface-container-high);
      border-color: var(--md-sys-color-outline);
      color: var(--md-sys-color-on-surface);
    }
    .copy-btn .material-symbols-rounded { font-size: 14px; }

    /* Preview content */
    .preview-content {
      flex: 1;
      overflow: auto;
      position: relative;
    }

    .preview-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      color: var(--md-sys-color-on-surface-variant);
    }
    .preview-empty .material-symbols-rounded {
      font-size: 48px;
      opacity: 0.3;
    }
    .preview-empty p {
      font-size: 14px;
      opacity: 0.5;
    }

    /* Code view */
    #code-view {
      display: none;
    }
    #code-view.active { display: block; }
    #code-content {
      padding: 20px 24px;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 13px;
      line-height: 1.7;
      color: #D4D4D4;
      white-space: pre;
      overflow-x: auto;
    }

    /* PineUI view */
    #pineui-view {
      display: none;
      height: 100%;
    }
    #pineui-view.active { display: flex; flex-direction: column; }
    #pineui-frame {
      flex: 1;
      border: none;
      width: 100%;
      background: #FFFBFE;
    }

    /* Generating overlay */
    .generating-bar {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(103, 80, 164, 0.12);
      border-bottom: 1px solid rgba(103, 80, 164, 0.2);
      font-size: 12px;
      color: #D0BCFF;
      flex-shrink: 0;
    }
    .generating-bar.visible { display: flex; }
    .gen-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(208, 188, 255, 0.3);
      border-top-color: #D0BCFF;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--md-sys-color-outline-variant); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--md-sys-color-outline); }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-logo">
      <div class="pine-icon">üçç</div>
      <h1>PineUI Builder</h1>
      <span>AI-powered</span>
    </div>
    <div class="topbar-spacer"></div>
    <div class="topbar-hint">
      <span class="material-symbols-rounded" style="font-size:14px">auto_awesome</span>
      Powered by Claude
    </div>
  </div>

  <!-- Main layout -->
  <div class="main">

    <!-- Chat panel -->
    <div class="chat-panel">
      <div class="chat-messages" id="chat-messages">
        <div class="chat-empty" id="chat-empty">
          <div class="empty-icon">
            <span class="material-symbols-rounded">widgets</span>
          </div>
          <h2>Build UIs with AI</h2>
          <p>Describe the interface you want and Claude will generate a PineUI schema instantly.</p>
          <div class="suggestion-chips">
            <button class="chip-btn" onclick="useSuggestion(this)">
              üìä A dashboard with sales metrics, charts and a recent orders table
            </button>
            <button class="chip-btn" onclick="useSuggestion(this)">
              üõí An e-commerce product listing with filters and a cart
            </button>
            <button class="chip-btn" onclick="useSuggestion(this)">
              üìù A task management app with categories and status badges
            </button>
            <button class="chip-btn" onclick="useSuggestion(this)">
              üë§ A user profile page with avatar, stats and activity feed
            </button>
          </div>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea
            id="chat-input"
            placeholder="Describe the UI you want to build..."
            rows="1"
          ></textarea>
          <button class="send-btn" id="send-btn" onclick="sendMessage()">
            <span class="material-symbols-rounded">arrow_upward</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Preview panel -->
    <div class="preview-panel">
      <div class="generating-bar" id="generating-bar">
        <div class="gen-spinner"></div>
        <span>Generating PineUI schema...</span>
      </div>

      <div class="preview-toolbar">
        <span class="preview-title" id="preview-label">Waiting for a prompt...</span>
        <div class="toggle-group">
          <button class="toggle-btn active" id="btn-view" onclick="setTab('view')">
            <span class="material-symbols-rounded">visibility</span>
            View
          </button>
          <button class="toggle-btn" id="btn-code" onclick="setTab('code')">
            <span class="material-symbols-rounded">code</span>
            Code
          </button>
        </div>
        <button class="copy-btn" id="copy-btn" onclick="copyCode()" style="display:none">
          <span class="material-symbols-rounded">content_copy</span>
          Copy
        </button>
      </div>

      <div class="preview-content">
        <div id="pineui-view" class="active">
          <div class="preview-empty" id="preview-empty">
            <span style="font-size:48px;opacity:0.3;filter:grayscale(1)">üçç</span>
            <p>Your generated UI will appear here</p>
          </div>
          <iframe id="pineui-frame" style="display:none"></iframe>
        </div>
        <div id="code-view">
          <pre id="code-content"></pre>
        </div>
      </div>
    </div>

  </div>

  <script>
    let currentSchema = null;
    let conversationHistory = [];
    let isGenerating = false;
    let activeTab = 'view';

    const chatMessages = document.getElementById('chat-messages');
    const chatEmpty = document.getElementById('chat-empty');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const generatingBar = document.getElementById('generating-bar');
    const previewLabel = document.getElementById('preview-label');
    const copyBtn = document.getElementById('copy-btn');

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function useSuggestion(el) {
      chatInput.value = el.textContent.trim().replace(/^[^\s]+ /, '');
      chatInput.focus();
      sendMessage();
    }

    function setTab(tab) {
      activeTab = tab;
      document.getElementById('btn-view').classList.toggle('active', tab === 'view');
      document.getElementById('btn-code').classList.toggle('active', tab === 'code');
      document.getElementById('pineui-view').classList.toggle('active', tab === 'view');
      document.getElementById('code-view').classList.toggle('active', tab === 'code');
    }

    async function copyCode() {
      if (!currentSchema) return;
      const text = JSON.stringify(currentSchema, null, 2);
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById('copy-btn');
      const icon = btn.querySelector('.material-symbols-rounded');
      const label = btn.childNodes[1];
      icon.textContent = 'check';
      btn.childNodes[btn.childNodes.length - 1].textContent = ' Copied!';
      setTimeout(() => {
        icon.textContent = 'content_copy';
        btn.childNodes[btn.childNodes.length - 1].textContent = ' Copy';
      }, 2000);
    }

    function appendMessage(role, content) {
      if (chatEmpty) chatEmpty.style.display = 'none';

      const msg = document.createElement('div');
      msg.className = `message ${role}`;
      msg.innerHTML = `
        <div class="msg-avatar ${role === 'ai' ? 'ai' : 'user-av'}">
          ${role === 'ai' ? 'üçç' : 'U'}
        </div>
        <div class="msg-bubble">
          <div class="msg-text">${escapeHtml(content)}</div>
        </div>
      `;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return msg;
    }

    function appendAiMessage() {
      if (chatEmpty) chatEmpty.style.display = 'none';

      const msg = document.createElement('div');
      msg.className = 'message ai';
      msg.innerHTML = `
        <div class="msg-avatar ai">üçç</div>
        <div class="msg-bubble">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
          <div class="msg-description" style="display:none"></div>
          <button class="msg-view-btn" style="display:none" onclick="setTab('view')">
            <span class="material-symbols-rounded" style="font-size:12px">open_in_new</span>
            View result
          </button>
        </div>
      `;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return msg;
    }

    function extractJsonFromText(text) {
      const match = text.match(/```json\s*([\s\S]*?)```/);
      if (match) {
        try { return JSON.parse(match[1]); } catch { return null; }
      }
      try { return JSON.parse(text); } catch { return null; }
    }

    function extractDescription(text) {
      const lines = text.split('\n').filter(l => l.trim());
      const firstNonJson = lines.find(l => !l.startsWith('```') && !l.startsWith('{'));
      return firstNonJson || '';
    }

    function renderPineUI(schema) {
      const empty = document.getElementById('preview-empty');
      const frame = document.getElementById('pineui-frame');

      empty.style.display = 'none';
      frame.style.display = 'block';

      frame.srcdoc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://pineui.github.io/PineUI/pineui.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { min-height: 100vh; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script src="https://pineui.github.io/PineUI/pineui.standalone.js"><\/script>
  <script>
    PineUI.render({
      target: '#app',
      schema: ${JSON.stringify(schema)}
    });
  <\/script>
</body>
</html>`;
    }

    function updateCodeView(schema) {
      document.getElementById('code-content').textContent = JSON.stringify(schema, null, 2);
      copyBtn.style.display = 'flex';
    }

    function streamToCodeView(text) {
      const el = document.getElementById('code-content');
      const scroller = document.querySelector('.preview-content');
      const atBottom = scroller.scrollHeight - scroller.scrollTop - scroller.clientHeight < 32;
      el.textContent = text;
      if (atBottom) scroller.scrollTop = scroller.scrollHeight;
    }

    // Extract only the JSON portion from streamed text (partial or complete)
    function extractStreamingJson(text) {
      const start = text.indexOf('```json');
      if (start === -1) return null;
      const jsonStart = text.indexOf('\n', start) + 1;
      const end = text.indexOf('```', start + 7);
      return end === -1
        ? text.slice(jsonStart)           // still streaming
        : text.slice(jsonStart, end);     // complete
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    async function sendMessage() {
      const prompt = chatInput.value.trim();
      if (!prompt || isGenerating) return;

      isGenerating = true;
      sendBtn.disabled = true;
      chatInput.value = '';
      chatInput.style.height = 'auto';

      appendMessage('user', prompt);
      const aiMsg = appendAiMessage();
      const typingIndicator = aiMsg.querySelector('.typing-indicator');
      const descEl = aiMsg.querySelector('.msg-description');
      const viewBtn = aiMsg.querySelector('.msg-view-btn');

      // Switch to Code immediately so the user sees JSON being written
      setTab('code');
      streamToCodeView('');
      copyBtn.style.display = 'none';

      generatingBar.classList.add('visible');
      previewLabel.textContent = 'Generating...';

      let fullText = '';

      try {
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, history: conversationHistory }),
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        typingIndicator.style.display = 'none';
        descEl.style.display = 'block';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const data = line.slice(6);
            if (data === '[DONE]') continue;

            try {
              const { text, error } = JSON.parse(data);
              if (error) throw new Error(error);
              if (text) {
                fullText += text;

                // Update description in chat bubble
                const desc = extractDescription(fullText);
                if (desc) descEl.textContent = desc;

                // Live-stream JSON portion into code view
                const jsonChunk = extractStreamingJson(fullText);
                if (jsonChunk !== null) streamToCodeView(jsonChunk);

                chatMessages.scrollTop = chatMessages.scrollHeight;
              }
            } catch {}
          }
        }

        // Parse and render schema
        const schema = extractJsonFromText(fullText);
        if (schema) {
          currentSchema = schema;

          // Show formatted JSON in code view
          updateCodeView(schema);

          // Render and auto-switch to View
          renderPineUI(schema);
          setTimeout(() => setTab('view'), 400);

          viewBtn.style.display = 'inline-flex';
          viewBtn.textContent = '';
          viewBtn.innerHTML = `<span class="material-symbols-rounded" style="font-size:12px">code</span> View code`;
          viewBtn.onclick = () => setTab('code');

          previewLabel.textContent = prompt.length > 50 ? prompt.slice(0, 50) + '...' : prompt;

          conversationHistory.push({ role: 'user', content: prompt });
          conversationHistory.push({ role: 'assistant', content: fullText });
          if (conversationHistory.length > 20) conversationHistory = conversationHistory.slice(-20);
        } else {
          previewLabel.textContent = 'Could not parse schema';
          descEl.textContent = fullText || 'No response received.';
        }

      } catch (err) {
        typingIndicator.style.display = 'none';
        descEl.style.display = 'block';
        descEl.textContent = `Error: ${err.message}`;
        previewLabel.textContent = 'Error';
      } finally {
        isGenerating = false;
        sendBtn.disabled = false;
        generatingBar.classList.remove('visible');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
  </script>
</body>
</html>
