<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PineUI Builder</title>

  <!-- Material Symbols -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />
  <!-- PineUI CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@pineui/react@latest/dist/style.css" />

  <style>
    :root {
      --md-sys-color-primary: #6750A4;
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-primary-container: #EADDFF;
      --md-sys-color-on-primary-container: #21005D;
      --md-sys-color-secondary: #625B71;
      --md-sys-color-secondary-container: #E8DEF8;
      --md-sys-color-surface: #141218;
      --md-sys-color-surface-variant: #1E1B21;
      --md-sys-color-surface-container: #211F26;
      --md-sys-color-surface-container-high: #2B2930;
      --md-sys-color-on-surface: #E6E1E5;
      --md-sys-color-on-surface-variant: #CAC4D0;
      --md-sys-color-outline: #938F99;
      --md-sys-color-outline-variant: #49454F;
      --md-sys-color-error: #F2B8B5;
      --md-ref-typeface-brand: 'Inter', sans-serif;
      --md-ref-typeface-plain: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: var(--md-sys-color-surface-container);
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      flex-shrink: 0;
    }
    .topbar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .topbar-logo .pine-icon {
      width: 32px;
      height: 32px;
      background: var(--md-sys-color-primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .topbar-logo h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--md-sys-color-on-surface);
      letter-spacing: -0.3px;
    }
    .topbar-logo span {
      font-size: 11px;
      font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      background: var(--md-sys-color-surface-container-high);
      padding: 2px 8px;
      border-radius: 100px;
      border: 1px solid var(--md-sys-color-outline-variant);
    }
    .topbar-spacer { flex: 1; }
    .topbar-hint {
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Chat panel ‚îÄ‚îÄ */
    .chat-panel {
      width: 420px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--md-sys-color-outline-variant);
      background: var(--md-sys-color-surface);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scrollbar-width: thin;
      scrollbar-color: var(--md-sys-color-outline-variant) transparent;
    }

    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 32px;
      text-align: center;
    }
    .chat-empty .empty-icon {
      width: 56px;
      height: 56px;
      background: var(--md-sys-color-primary-container);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: var(--md-sys-color-on-primary-container);
    }
    .chat-empty h2 {
      font-size: 16px;
      font-weight: 600;
      color: var(--md-sys-color-on-surface);
    }
    .chat-empty p {
      font-size: 13px;
      color: var(--md-sys-color-on-surface-variant);
      line-height: 1.5;
    }

    .suggestion-chips {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      width: 100%;
    }
    .chip-btn {
      background: var(--md-sys-color-surface-container);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 12px;
      padding: 10px 14px;
      color: var(--md-sys-color-on-surface);
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      text-align: left;
      transition: background 0.15s, border-color 0.15s;
      line-height: 1.4;
    }
    .chip-btn:hover {
      background: var(--md-sys-color-surface-container-high);
      border-color: var(--md-sys-color-primary);
    }

    /* Messages */
    .message {
      display: flex;
      gap: 10px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.user { flex-direction: row-reverse; }

    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }
    .msg-avatar.ai {
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
    }
    .msg-avatar.user-av {
      background: var(--md-sys-color-secondary-container);
      color: #1D1B20;
    }

    .msg-bubble {
      max-width: 85%;
      border-radius: 16px;
      padding: 10px 14px;
      font-size: 13px;
      line-height: 1.6;
    }
    .message.user .msg-bubble {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      border-bottom-right-radius: 4px;
    }
    .message.ai .msg-bubble {
      background: var(--md-sys-color-surface-container);
      color: var(--md-sys-color-on-surface);
      border-bottom-left-radius: 4px;
    }
    .msg-bubble .msg-description {
      color: var(--md-sys-color-on-surface-variant);
      font-size: 12px;
      line-height: 1.5;
    }
    .msg-bubble .msg-view-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      font-size: 12px;
      font-weight: 500;
      color: #D0BCFF;
      cursor: pointer;
      background: none;
      border: none;
      padding: 4px 0;
      font-family: 'Inter', sans-serif;
    }
    .msg-bubble .msg-view-btn:hover { text-decoration: underline; }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 4px 0;
    }
    .typing-dot {
      width: 6px;
      height: 6px;
      background: var(--md-sys-color-on-surface-variant);
      border-radius: 50%;
      animation: typing 1.2s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-4px); opacity: 1; }
    }

    /* Chat input */
    .chat-input-area {
      padding: 12px 16px 16px;
      border-top: 1px solid var(--md-sys-color-outline-variant);
      background: var(--md-sys-color-surface);
    }
    .chat-input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: var(--md-sys-color-surface-container);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 16px;
      padding: 8px 8px 8px 16px;
      transition: border-color 0.2s;
    }
    .chat-input-wrapper:focus-within {
      border-color: var(--md-sys-color-primary);
    }
    #chat-input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--md-sys-color-on-surface);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    #chat-input::placeholder { color: var(--md-sys-color-on-surface-variant); }

    .send-btn {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: var(--md-sys-color-primary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--md-sys-color-on-primary);
      flex-shrink: 0;
      transition: background 0.15s, opacity 0.15s;
    }
    .send-btn:hover:not(:disabled) { background: #7966AF; }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .send-btn .material-symbols-rounded { font-size: 18px; }

    /* ‚îÄ‚îÄ Preview panel ‚îÄ‚îÄ */
    .preview-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--md-sys-color-surface-variant);
      overflow: hidden;
    }

    .preview-toolbar {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--md-sys-color-surface-container);
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      gap: 12px;
      flex-shrink: 0;
    }

    .preview-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      flex: 1;
    }

    /* Segmented button toggle */
    .toggle-group {
      display: flex;
      border: 1px solid var(--md-sys-color-outline);
      border-radius: 100px;
      overflow: hidden;
    }
    .toggle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 16px;
      font-size: 12px;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      border: none;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      background: transparent;
      color: var(--md-sys-color-on-surface-variant);
    }
    .toggle-btn.active {
      background: var(--md-sys-color-secondary-container);
      color: #1D1B20;
    }
    .toggle-btn:not(.active):hover {
      background: rgba(255,255,255,0.05);
    }
    .toggle-btn .material-symbols-rounded { font-size: 14px; }

    .copy-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 100px;
      cursor: pointer;
      background: transparent;
      color: var(--md-sys-color-on-surface-variant);
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .copy-btn:hover {
      background: var(--md-sys-color-surface-container-high);
      border-color: var(--md-sys-color-outline);
      color: var(--md-sys-color-on-surface);
    }
    .copy-btn .material-symbols-rounded { font-size: 14px; }

    /* Preview content */
    .preview-content {
      flex: 1;
      overflow: auto;
      position: relative;
    }

    .preview-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      color: var(--md-sys-color-on-surface-variant);
    }
    .preview-empty .material-symbols-rounded {
      font-size: 48px;
      opacity: 0.3;
    }
    .preview-empty p {
      font-size: 14px;
      opacity: 0.5;
    }

    /* Code view */
    #code-view {
      display: none;
    }
    #code-view.active { display: block; }
    #code-content {
      padding: 20px 24px;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 13px;
      line-height: 1.7;
      color: #D4D4D4;
      white-space: pre;
      overflow-x: auto;
    }

    /* PineUI view */
    #pineui-view {
      display: none;
      height: 100%;
    }
    #pineui-view.active { display: flex; flex-direction: column; }
    #pineui-frame {
      flex: 1;
      border: none;
      width: 100%;
      background: #FFFBFE;
    }

    /* Generating overlay */
    .generating-bar {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(103, 80, 164, 0.12);
      border-bottom: 1px solid rgba(103, 80, 164, 0.2);
      font-size: 12px;
      color: #D0BCFF;
      flex-shrink: 0;
    }
    .generating-bar.visible { display: flex; }
    .gen-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(208, 188, 255, 0.3);
      border-top-color: #D0BCFF;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--md-sys-color-outline-variant); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--md-sys-color-outline); }

    /* ‚îÄ‚îÄ Modal overlay ‚îÄ‚îÄ */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .modal-backdrop.open { display: flex; }

    .modal-box {
      background: var(--md-sys-color-surface-container);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 20px;
      width: 680px;
      max-width: calc(100vw - 32px);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: modalIn 0.18s ease;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.96) translateY(8px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }
    .modal-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      gap: 12px;
      flex-shrink: 0;
    }
    .modal-header h2 {
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }
    .modal-close {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--md-sys-color-on-surface-variant);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      transition: background 0.15s;
    }
    .modal-close:hover { background: var(--md-sys-color-surface-container-high); }

    .modal-body {
      overflow-y: auto;
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Load by filename */
    .load-local {
      display: flex;
      gap: 8px;
      align-items: center;
      background: var(--md-sys-color-surface-container-high);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 12px;
      padding: 12px 16px;
    }
    .load-local label {
      font-size: 12px;
      font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      white-space: nowrap;
    }
    .load-local input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      font-family: 'SF Mono','Fira Code',monospace;
      font-size: 13px;
      color: var(--md-sys-color-on-surface);
    }
    .load-local input::placeholder { color: var(--md-sys-color-on-surface-variant); opacity: 0.6; }

    /* Projects grid */
    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }
    .projects-empty {
      text-align: center;
      padding: 32px;
      color: var(--md-sys-color-on-surface-variant);
      font-size: 13px;
      opacity: 0.6;
    }
    .project-card {
      background: var(--md-sys-color-surface-container-high);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 12px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: border-color 0.15s;
    }
    .project-card:hover { border-color: var(--md-sys-color-primary); }
    .project-card-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--md-sys-color-on-surface);
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.4;
    }
    .project-card-date {
      font-size: 11px;
      color: var(--md-sys-color-on-surface-variant);
    }
    .project-card-id {
      font-size: 10px;
      font-family: 'SF Mono','Fira Code',monospace;
      color: var(--md-sys-color-on-surface-variant);
      opacity: 0.6;
    }
    .project-card-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }
    .project-card-actions a,
    .project-card-actions button {
      flex: 1;
      padding: 5px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      border: 1px solid var(--md-sys-color-outline-variant);
      background: transparent;
      color: var(--md-sys-color-on-surface-variant);
      transition: background 0.15s, color 0.15s;
    }
    .project-card-actions button.load-btn {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      border-color: transparent;
    }
    .project-card-actions button.load-btn:hover { background: #7966AF; }
    .project-card-actions a:hover,
    .project-card-actions button.del-btn:hover {
      background: var(--md-sys-color-surface-container);
      color: var(--md-sys-color-on-surface);
    }
    .project-card-actions button.del-btn:hover { color: #F2B8B5; border-color: #F2B8B5; }

    /* Save dialog */
    .save-dialog {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 200;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
    }
    .save-dialog.open { display: flex; }
    .save-dialog-box {
      background: var(--md-sys-color-surface-container);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 16px;
      padding: 24px;
      width: 420px;
      max-width: calc(100vw - 32px);
      display: flex;
      flex-direction: column;
      gap: 16px;
      animation: modalIn 0.15s ease;
    }
    .save-dialog-box h3 { font-size: 15px; font-weight: 600; }
    .save-name-input {
      background: var(--md-sys-color-surface-container-high);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 10px;
      padding: 10px 14px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      color: var(--md-sys-color-on-surface);
      outline: none;
      transition: border-color 0.2s;
    }
    .save-name-input:focus { border-color: var(--md-sys-color-primary); }
    .save-dialog-actions { display: flex; gap: 8px; justify-content: flex-end; }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-logo">
      <div class="pine-icon">üçç</div>
      <h1>PineUI Builder</h1>
      <span>AI-powered</span>
    </div>
    <div class="topbar-spacer"></div>
    <button class="copy-btn" onclick="newProject()" title="Start a new project">
      <span class="material-symbols-rounded">add</span>
      New
    </button>
    <button class="copy-btn" onclick="openProjectsModal()" title="Saved projects">
      <span class="material-symbols-rounded">folder_open</span>
      Projects
    </button>
    <div class="topbar-hint">
      <span class="material-symbols-rounded" style="font-size:14px">auto_awesome</span>
      Powered by Claude
    </div>
  </div>

  <!-- Main layout -->
  <div class="main">

    <!-- Chat panel -->
    <div class="chat-panel">
      <div class="chat-messages" id="chat-messages">
        <div class="chat-empty" id="chat-empty">
          <div class="empty-icon">
            <span class="material-symbols-rounded">widgets</span>
          </div>
          <h2>Build UIs with AI</h2>
          <p>Describe the interface you want and Claude will generate a PineUI schema instantly.</p>
          <div class="suggestion-chips">
            <button class="chip-btn" onclick="useSuggestion(this)">
              üìä A dashboard with sales metrics, charts and a recent orders table
            </button>
            <button class="chip-btn" onclick="useSuggestion(this)">
              üõí An e-commerce product listing with filters and a cart
            </button>
            <button class="chip-btn" onclick="useSuggestion(this)">
              üìù A task management app with categories and status badges
            </button>
            <button class="chip-btn" onclick="useSuggestion(this)">
              üë§ A user profile page with avatar, stats and activity feed
            </button>
          </div>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea
            id="chat-input"
            placeholder="Describe the UI you want to build..."
            rows="1"
          ></textarea>
          <button class="send-btn" id="send-btn" onclick="sendMessage()">
            <span class="material-symbols-rounded">arrow_upward</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Preview panel -->
    <div class="preview-panel">
      <div class="generating-bar" id="generating-bar">
        <div class="gen-spinner"></div>
        <span>Generating PineUI schema...</span>
      </div>

      <div class="preview-toolbar">
        <span class="preview-title" id="preview-label">Waiting for a prompt...</span>
        <div class="toggle-group">
          <button class="toggle-btn active" id="btn-view" onclick="setTab('view')">
            <span class="material-symbols-rounded">visibility</span>
            View
          </button>
          <button class="toggle-btn" id="btn-code" onclick="setTab('code')">
            <span class="material-symbols-rounded">code</span>
            Code
          </button>
        </div>
        <button class="copy-btn" id="save-btn" onclick="openSaveDialog()" style="display:none">
          <span class="material-symbols-rounded">save</span>
          Save
        </button>
        <button class="copy-btn" id="copy-btn" onclick="copyCode()" style="display:none">
          <span class="material-symbols-rounded">content_copy</span>
          Copy
        </button>
      </div>

      <div class="preview-content">
        <div id="pineui-view" class="active">
          <div class="preview-empty" id="preview-empty">
            <span style="font-size:48px;opacity:0.3;filter:grayscale(1)">üçç</span>
            <p>Your generated UI will appear here</p>
          </div>
          <iframe id="pineui-frame" style="display:none"></iframe>
        </div>
        <div id="code-view">
          <pre id="code-content"></pre>
        </div>
      </div>
    </div>

  </div>

  <!-- Projects modal -->
  <div class="modal-backdrop" id="projects-modal" onclick="handleModalClick(event)">
    <div class="modal-box">
      <div class="modal-header">
        <span class="material-symbols-rounded" style="color:var(--md-sys-color-primary)">folder_open</span>
        <h2>Saved Projects</h2>
        <button class="modal-close" onclick="closeProjectsModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="load-local">
          <label>Load by ID:</label>
          <input id="load-local-input" placeholder="e.g. a3f2c91d04" spellcheck="false"
            onkeydown="if(event.key==='Enter') loadByFilename()" />
          <button class="copy-btn" onclick="loadByFilename()" style="flex-shrink:0">
            <span class="material-symbols-rounded">upload_file</span>
            Load
          </button>
        </div>
        <div id="projects-grid" class="projects-grid"></div>
      </div>
    </div>
  </div>

  <!-- Save dialog -->
  <div class="save-dialog" id="save-dialog" onclick="handleSaveBackdropClick(event)">
    <div class="save-dialog-box">
      <h3>üíæ Save Project</h3>
      <input class="save-name-input" id="save-name-input" placeholder="Project name..."
        onkeydown="if(event.key==='Enter') confirmSave()" />
      <div class="save-dialog-actions">
        <button class="copy-btn" onclick="closeSaveDialog()">Cancel</button>
        <button class="copy-btn" onclick="confirmSave()"
          style="background:var(--md-sys-color-primary);color:var(--md-sys-color-on-primary);border-color:transparent">
          <span class="material-symbols-rounded">save</span>
          Save
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentSchema = null;
    let conversationHistory = [];
    let isGenerating = false;
    let activeTab = 'view';
    let currentProjectId = null; // stable session ID, set on first auto-save

    // Generate a random 10-char hex ID for a new session
    function generateSessionId() {
      return Array.from(crypto.getRandomValues(new Uint8Array(5)))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // Auto-save silently and update the browser URL
    async function autoSave(schema, prompt) {
      if (!currentProjectId) currentProjectId = generateSessionId();
      try {
        const res = await fetch('/api/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: currentProjectId,
            schema,
            name: prompt.slice(0, 80),
            prompt,
          }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
          throw new Error(err.error);
        }
        history.pushState({ id: currentProjectId }, '', `/projects/${currentProjectId}`);
        document.getElementById('save-btn').style.display = 'flex';
      } catch (err) {
        console.warn('Auto-save failed:', err.message);
        showToast('Auto-save failed: ' + err.message);
      }
    }

    // On page load ‚Äî if URL is /projects/:id, load that project
    (async function bootLoad() {
      const match = location.pathname.match(/^\/projects\/([a-f0-9]{10})$/);
      if (!match) return;
      const id = match[1];
      document.getElementById('preview-label').textContent = 'Loading project...';
      try {
        const res = await fetch(`/api/projects/load/${id}`);
        if (!res.ok) {
          history.replaceState({}, '', '/');
          document.getElementById('preview-label').textContent = 'Waiting for a prompt...';
          showToast('Project not found ‚Äî start a new conversation below');
          return;
        }
        const schema = await res.json();
        currentSchema = schema;
        currentProjectId = id;
        renderPineUI(schema);
        updateCodeView(schema);
        document.getElementById('save-btn').style.display = 'flex';
        document.getElementById('copy-btn').style.display = 'flex';
        document.getElementById('preview-label').textContent = id;
        document.getElementById('preview-empty').style.display = 'none';
        seedHistory(schema);
        setTab('view');
        // Hide empty state and show a loaded message in chat
        if (chatEmpty) chatEmpty.style.display = 'none';
        appendMessage('ai', 'Project loaded. You can describe changes or continue building from here.');
      } catch (err) {
        history.replaceState({}, '', '/');
        document.getElementById('preview-label').textContent = 'Waiting for a prompt...';
        console.warn('Failed to boot-load project:', err.message);
      }
    })();

    const chatMessages = document.getElementById('chat-messages');
    const chatEmpty = document.getElementById('chat-empty');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const generatingBar = document.getElementById('generating-bar');
    const previewLabel = document.getElementById('preview-label');
    const copyBtn = document.getElementById('copy-btn');

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function useSuggestion(el) {
      chatInput.value = el.textContent.trim().replace(/^[^\s]+ /, '');
      chatInput.focus();
      sendMessage();
    }

    function setTab(tab) {
      activeTab = tab;
      document.getElementById('btn-view').classList.toggle('active', tab === 'view');
      document.getElementById('btn-code').classList.toggle('active', tab === 'code');
      document.getElementById('pineui-view').classList.toggle('active', tab === 'view');
      document.getElementById('code-view').classList.toggle('active', tab === 'code');
    }

    async function copyCode() {
      if (!currentSchema) return;
      const text = JSON.stringify(currentSchema, null, 2);
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById('copy-btn');
      const icon = btn.querySelector('.material-symbols-rounded');
      const label = btn.childNodes[1];
      icon.textContent = 'check';
      btn.childNodes[btn.childNodes.length - 1].textContent = ' Copied!';
      setTimeout(() => {
        icon.textContent = 'content_copy';
        btn.childNodes[btn.childNodes.length - 1].textContent = ' Copy';
      }, 2000);
    }

    function appendMessage(role, content) {
      if (chatEmpty) chatEmpty.style.display = 'none';

      const msg = document.createElement('div');
      msg.className = `message ${role}`;
      msg.innerHTML = `
        <div class="msg-avatar ${role === 'ai' ? 'ai' : 'user-av'}">
          ${role === 'ai' ? 'üçç' : 'U'}
        </div>
        <div class="msg-bubble">
          <div class="msg-text">${escapeHtml(content)}</div>
        </div>
      `;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return msg;
    }

    function appendAiMessage() {
      if (chatEmpty) chatEmpty.style.display = 'none';

      const msg = document.createElement('div');
      msg.className = 'message ai';
      msg.innerHTML = `
        <div class="msg-avatar ai">üçç</div>
        <div class="msg-bubble">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
          <div class="msg-description" style="display:none"></div>
          <button class="msg-view-btn" style="display:none" onclick="setTab('view')">
            <span class="material-symbols-rounded" style="font-size:12px">open_in_new</span>
            View result
          </button>
        </div>
      `;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return msg;
    }

    function extractJsonFromText(text) {
      const match = text.match(/```json\s*([\s\S]*?)```/);
      if (match) {
        try { return JSON.parse(match[1]); } catch { return null; }
      }
      try { return JSON.parse(text); } catch { return null; }
    }

    function extractDescription(text) {
      const lines = text.split('\n').filter(l => l.trim());
      const firstNonJson = lines.find(l => !l.startsWith('```') && !l.startsWith('{'));
      return firstNonJson || '';
    }

    function renderPineUI(schema) {
      const empty = document.getElementById('preview-empty');
      const frame = document.getElementById('pineui-frame');

      empty.style.display = 'none';
      frame.style.display = 'block';

      frame.srcdoc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/@pineui/react@latest/dist/style.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { min-height: 100vh; }
  </style>
  <script>
    (function () {
      function fwd(level, args) {
        try { window.parent.postMessage({ type: '__pine_log__', level, args: Array.from(args).map(String) }, '*'); } catch(e) {}
      }
      ['log','warn','error','info'].forEach(function(l) {
        var orig = console[l].bind(console);
        console[l] = function() { fwd(l, arguments); orig.apply(console, arguments); };
      });
      window.onerror = function(msg, _src, line) {
        fwd('error', ['[uncaught] ' + msg + ' (line ' + line + ')']);
      };
      window.onunhandledrejection = function(e) {
        fwd('error', ['[unhandled rejection] ' + (e.reason && e.reason.message || String(e.reason))]);
      };
    })();
  <\/script>
</head>
<body>
  <div id="app"></div>
  <script src="https://unpkg.com/@pineui/react@latest/dist/pineui.standalone.js"><\/script>
  <script>
    PineUI.render({
      target: '#app',
      schema: ${JSON.stringify(schema)}
    });
  <\/script>
</body>
</html>`;
    }

    function updateCodeView(schema) {
      document.getElementById('code-content').textContent = JSON.stringify(schema, null, 2);
      copyBtn.style.display = 'flex';
    }

    // Seed conversation history from a loaded schema so Claude can make incremental changes
    function seedHistory(schema) {
      conversationHistory = [
        { role: 'user', content: 'Generate a PineUI schema for this project.' },
        { role: 'assistant', content: 'Here is the generated PineUI schema:\n\n```json\n' + JSON.stringify(schema, null, 2) + '\n```' },
      ];
    }

    function streamToCodeView(text) {
      const el = document.getElementById('code-content');
      const scroller = document.querySelector('.preview-content');
      const atBottom = scroller.scrollHeight - scroller.scrollTop - scroller.clientHeight < 32;
      el.textContent = text;
      if (atBottom) scroller.scrollTop = scroller.scrollHeight;
    }

    // Extract only the JSON portion from streamed text (partial or complete)
    function extractStreamingJson(text) {
      const start = text.indexOf('```json');
      if (start === -1) return null;
      const jsonStart = text.indexOf('\n', start) + 1;
      const end = text.indexOf('```', start + 7);
      return end === -1
        ? text.slice(jsonStart)           // still streaming
        : text.slice(jsonStart, end);     // complete
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // ‚îÄ‚îÄ Projects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentPrompt = '';

    function newProject() {
      currentSchema = null;
      currentPrompt = '';
      currentProjectId = null;
      conversationHistory = [];
      history.pushState({}, '', '/');
      // Reset chat
      const msgs = document.getElementById('chat-messages');
      const empty = document.getElementById('chat-empty');
      msgs.innerHTML = '';
      msgs.appendChild(empty);
      empty.style.display = '';
      // Reset preview
      document.getElementById('preview-empty').style.display = '';
      document.getElementById('pineui-frame').style.display = 'none';
      document.getElementById('pineui-frame').srcdoc = '';
      document.getElementById('code-content').textContent = '';
      document.getElementById('save-btn').style.display = 'none';
      document.getElementById('copy-btn').style.display = 'none';
      document.getElementById('preview-label').textContent = 'Waiting for a prompt...';
      setTab('view');
    }

    function openProjectsModal() {
      document.getElementById('projects-modal').classList.add('open');
      renderProjectsGrid();
    }
    function closeProjectsModal() {
      document.getElementById('projects-modal').classList.remove('open');
    }
    function handleModalClick(e) {
      if (e.target === document.getElementById('projects-modal')) closeProjectsModal();
    }

    async function renderProjectsGrid() {
      const grid = document.getElementById('projects-grid');
      grid.innerHTML = '<div class="projects-empty">Loading...</div>';
      try {
        const res = await fetch('/api/projects');
        const projects = await res.json();
        if (!projects.length) {
          grid.innerHTML = '<div class="projects-empty">No saved projects yet.<br>Generate a UI and click Save.</div>';
          return;
        }
        grid.innerHTML = projects.map(p => `
          <div class="project-card">
            <div class="project-card-name">${escapeHtml(p.name)}</div>
            <div class="project-card-date">${new Date(p.updatedAt).toLocaleDateString('en', {day:'2-digit',month:'short',year:'numeric'})}</div>
            <div class="project-card-id">${p.id}</div>
            <div class="project-card-actions">
              <button class="load-btn" onclick="loadProject('${p.id}')">Load</button>
              <a href="${p.url}" target="_blank" rel="noopener">JSON</a>
              <button class="del-btn" onclick="deleteProject('${p.id}', this)">Delete</button>
            </div>
          </div>
        `).join('');
      } catch {
        grid.innerHTML = '<div class="projects-empty">Failed to load projects.</div>';
      }
    }

    async function loadProject(id) {
      try {
        const res = await fetch(`/api/projects/load/${id}`);
        if (!res.ok) throw new Error('Not found');
        const schema = await res.json();
        currentSchema = schema;
        currentProjectId = id;
        seedHistory(schema);
        renderPineUI(schema);
        updateCodeView(schema);
        document.getElementById('save-btn').style.display = 'flex';
        document.getElementById('copy-btn').style.display = 'flex';
        document.getElementById('preview-label').textContent = id;
        history.pushState({ id }, '', `/projects/${id}`);
        // Hide empty state and show context message in chat
        document.getElementById('chat-empty').style.display = 'none';
        appendMessage('ai', 'Project loaded. You can describe changes or continue building from here.');
        setTab('view');
        closeProjectsModal();
      } catch (err) {
        alert('Failed to load project: ' + err.message);
      }
    }

    async function loadByFilename() {
      const raw = document.getElementById('load-local-input').value.trim();
      const id = raw.replace(/\.json$/i, '').replace(/[^a-f0-9]/g, '');
      if (!id) return;
      await loadProject(id);
    }

    async function deleteProject(id, btn) {
      if (!confirm('Delete this project?')) return;
      btn.disabled = true;
      try {
        await fetch(`/api/projects/${id}`, { method: 'DELETE' });
        renderProjectsGrid();
      } catch {
        btn.disabled = false;
      }
    }

    function openSaveDialog() {
      if (!currentSchema) return;
      const input = document.getElementById('save-name-input');
      input.value = currentPrompt.slice(0, 80);
      document.getElementById('save-dialog').classList.add('open');
      setTimeout(() => { input.focus(); input.select(); }, 50);
    }
    function closeSaveDialog() {
      document.getElementById('save-dialog').classList.remove('open');
    }
    function handleSaveBackdropClick(e) {
      if (e.target === document.getElementById('save-dialog')) closeSaveDialog();
    }

    async function confirmSave() {
      if (!currentSchema) return;
      const name = document.getElementById('save-name-input').value.trim() || 'Untitled';
      closeSaveDialog();
      try {
        const res = await fetch('/api/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: currentProjectId, schema: currentSchema, name, prompt: currentPrompt }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
          throw new Error(err.error);
        }
        const project = await res.json();
        showToast(`Saved! ID: ${project.id}`, project.url);
      } catch (err) {
        showToast('Failed to save: ' + err.message);
      }
    }

    function showToast(msg, link) {
      const existing = document.getElementById('toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.cssText = `
        position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
        background:var(--md-sys-color-surface-container-high);
        border:1px solid var(--md-sys-color-outline-variant);
        border-radius:100px; padding:10px 20px; font-size:13px;
        color:var(--md-sys-color-on-surface); display:flex; align-items:center;
        gap:10px; z-index:300; box-shadow:0 4px 24px rgba(0,0,0,0.3);
        animation:fadeIn 0.2s ease;
      `;
      toast.innerHTML = escapeHtml(msg);
      if (link) {
        const a = document.createElement('a');
        a.href = link;
        a.target = '_blank';
        a.style.cssText = 'color:#D0BCFF;font-size:12px;text-decoration:none;';
        a.textContent = 'View JSON';
        toast.appendChild(a);
      }
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // Forward PineUI iframe console messages to the parent DevTools
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === '__pine_log__') {
        const { level, args } = e.data;
        (console[level] || console.log)('[PineUI]', ...args);
      }
    });

    async function sendMessage() {
      const prompt = chatInput.value.trim();
      if (!prompt || isGenerating) return;

      isGenerating = true;
      sendBtn.disabled = true;
      chatInput.value = '';
      chatInput.style.height = 'auto';

      appendMessage('user', prompt);
      const aiMsg = appendAiMessage();
      const typingIndicator = aiMsg.querySelector('.typing-indicator');
      const descEl = aiMsg.querySelector('.msg-description');
      const viewBtn = aiMsg.querySelector('.msg-view-btn');

      // Switch to Code immediately so the user sees JSON being written
      setTab('code');
      streamToCodeView('');
      copyBtn.style.display = 'none';

      generatingBar.classList.add('visible');
      previewLabel.textContent = 'Generating...';

      let fullText = '';

      try {
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, history: conversationHistory }),
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        typingIndicator.style.display = 'none';
        descEl.style.display = 'block';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const data = line.slice(6);
            if (data === '[DONE]') continue;

            try {
              const { text, error } = JSON.parse(data);
              if (error) throw new Error(error);
              if (text) {
                fullText += text;

                // Update description in chat bubble
                const desc = extractDescription(fullText);
                if (desc) descEl.textContent = desc;

                // Live-stream JSON portion into code view
                const jsonChunk = extractStreamingJson(fullText);
                if (jsonChunk !== null) streamToCodeView(jsonChunk);

                chatMessages.scrollTop = chatMessages.scrollHeight;
              }
            } catch {}
          }
        }

        // Parse and render schema
        const schema = extractJsonFromText(fullText);
        if (schema) {
          currentSchema = schema;

          // Show formatted JSON in code view
          updateCodeView(schema);

          // Render and auto-switch to View
          renderPineUI(schema);
          setTimeout(() => setTab('view'), 400);

          viewBtn.style.display = 'inline-flex';
          viewBtn.textContent = '';
          viewBtn.innerHTML = `<span class="material-symbols-rounded" style="font-size:12px">code</span> View code`;
          viewBtn.onclick = () => setTab('code');

          currentPrompt = prompt;
          previewLabel.textContent = prompt.length > 50 ? prompt.slice(0, 50) + '...' : prompt;
          autoSave(schema, prompt);

          conversationHistory.push({ role: 'user', content: prompt });
          conversationHistory.push({ role: 'assistant', content: fullText });
          if (conversationHistory.length > 20) conversationHistory = conversationHistory.slice(-20);
        } else {
          previewLabel.textContent = 'Could not parse schema';
          descEl.textContent = fullText || 'No response received.';
        }

      } catch (err) {
        typingIndicator.style.display = 'none';
        descEl.style.display = 'block';
        descEl.textContent = `Error: ${err.message}`;
        previewLabel.textContent = 'Error';
      } finally {
        isGenerating = false;
        sendBtn.disabled = false;
        generatingBar.classList.remove('visible');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
  </script>
</body>
</html>
